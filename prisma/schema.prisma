generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RatingTier {
  EXCEPTIONAL
  HIGH
  AVERAGE
  LOW
}

enum ReviewCountTier {
  VERY_HIGH
  HIGH
  MODERATE
  LOW
}

enum PriceLevel {
  FREE
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

enum IndoorOutdoor {
  INDOOR
  OUTDOOR
  BOTH
}

enum SeasonalAvailability {
  ALL_YEAR
  SEASONAL
}

model User {
  id                  String   @id
  email               String   @unique
  firstName           String?
  lastName            String?
  profileImage        String?
  preferences         Json? // For storing user preferences that affect recommendations
  onboardingCompleted Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  trips               Trip[]
}

model Trip {
  id          String              @id @default(cuid())
  userId      String
  user        User                @relation(fields: [userId], references: [id])
  cityId      String
  city        City                @relation(fields: [cityId], references: [id])
  title       String
  startDate   DateTime
  endDate     DateTime
  preferences Json? // Trip-specific preferences
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  activities  ItineraryActivity[]

  @@index([userId])
  @@index([cityId])
}

model ActivityRecommendation {
  id          String @id @default(cuid())
  name        String
  description String
  cityId      String
  city        City   @relation(fields: [cityId], references: [id])

  // Core quality metrics
  rating          Float
  ratingTier      RatingTier
  reviewCount     Int
  reviewCountTier ReviewCountTier

  // Basic attributes
  isMustSee           Boolean  @default(false)
  isTouristAttraction Boolean  @default(false)
  placeTypes          String[] // ['museum', 'art_gallery', etc.]

  // Characteristics
  indoorOutdoor        IndoorOutdoor
  duration             Int // in minutes
  priceLevel           PriceLevel
  seasonalAvailability SeasonalAvailability @default(ALL_YEAR)

  // Location and media
  location Json // { latitude: number, longitude: number, address: string, placeId: string, neighborhood: string }
  images   Json // { urls: Array<{url: string, cdnUrl: string}> }

  // Operating hours
  openingHours  Json? // { periods: { open: { day: number, time: string }, close: { day: number, time: string } }[] }
  availableDays Int[] // [0,1,2,3,4,5,6] for days of week

  // External IDs and metadata
  googlePlaceId String?  @unique // For updating from Google Places
  googleTypes   String[] // Raw place types from Google
  lastSyncedAt  DateTime // Track when we last synced with Google

  viatorProductId String?
  viatorData      Json? // Store full Viator product data
  lastViatorSync  DateTime? // Track when we last synced with Viator

  // Relations and timestamps
  itineraryActivities ItineraryActivity[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([cityId])
  @@index([isMustSee])
  @@index([placeTypes])
  @@index([googlePlaceId])
}

model ItineraryActivity {
  id               String                 @id @default(cuid())
  tripId           String
  trip             Trip                   @relation(fields: [tripId], references: [id])
  recommendationId String
  recommendation   ActivityRecommendation @relation(fields: [recommendationId], references: [id])

  startTime               DateTime // When this activity is scheduled
  endTime                 DateTime
  notes                   String? // User notes for this instance
  status                  String   @default("planned") // planned, confirmed, completed, cancelled
  customizations          Json? // Any customizations from the recommendation template
  transitTimeFromPrevious Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tripId])
  @@index([recommendationId])
}

model City {
  id             String                   @id @default(cuid())
  name           String
  countryCode    String
  placeId        String
  latitude       Float
  longitude      Float
  viatorDestId   Int? // Store the matching Viator destinationId
  viatorLookupId String? // Store the lookupId for API calls
  viatorData     Json? // Store the full destination data
  lastViatorSync DateTime? // Track when we last synced with Viator
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  activities     ActivityRecommendation[]
  trips          Trip[]

  @@unique([name, countryCode])
}
